/*! simple-measure-tool 1.1 (customized for DG) */
(function(factory){
  if(typeof define==='function'&&define.amd){define(['leaflet'],factory);}
  else if(typeof module!=='undefined'){module.exports=factory(require('leaflet'));}
  else{factory(window.L);}
})(function(L){
  if(!L)return;

  L.Control.Measure=L.Control.extend({
    options:{
      position:'topleft',
      color:'#ffe066',
      activeColor:'#ffcc00',
      unit:'km',
      precision:2,
      tooltipClass:'dg-measure-tooltip'
    },

    onAdd:function(map){
      this._map=map;
      const container=L.DomUtil.create('div','leaflet-control-measure leaflet-bar');
      this._btn=L.DomUtil.create('a','leaflet-control-measure-toggle leaflet-bar-part',container);
      this._btn.href='#';
      this._btn.title='Measure distance';
      this._btn.innerHTML='ðŸ“';
      L.DomEvent.on(this._btn,'click',L.DomEvent.stopPropagation)
                .on(this._btn,'click',L.DomEvent.preventDefault)
                .on(this._btn,'click',this._toggle,this);
      return container;
    },

    onRemove:function(map){ this._disable(); },

    _toggle:function(){
      if(this._enabled){ this._disable(); }
      else { this._enable(); }
    },

    _enable:function(){
      this._enabled=true;
      L.DomUtil.addClass(this._btn,'active');
      this._layer=L.layerGroup().addTo(this._map);
      this._poly=L.polyline([],{
        color:this.options.color,
        weight:2
      }).addTo(this._layer);
      this._points=[];
      this._tooltip=L.DomUtil.create('div',this.options.tooltipClass);
      this._tooltip.innerHTML='Click to start measuring';
      this._map.getContainer().appendChild(this._tooltip);
      this._map.on('mousemove',this._move,this)
               .on('click',this._click,this)
               .on('keydown',this._keydown,this);
    },

    _disable:function(){
      this._enabled=false;
      L.DomUtil.removeClass(this._btn,'active');
      if(this._layer){ this._map.removeLayer(this._layer); }
      if(this._tooltip){ this._tooltip.remove(); }
      this._map.off('mousemove',this._move,this)
               .off('click',this._click,this)
               .off('keydown',this._keydown,this);
      this._layer=null; this._points=[]; this._poly=null; this._tooltip=null;
    },

    _click:function(e){
      const latlng=e.latlng;
      this._points.push(latlng);
      this._poly.addLatLng(latlng);
      this._updateTooltip(latlng);
    },

    _move:function(e){
      if(!this._tooltip)return;
      const pos=this._map.mouseEventToContainerPoint(e.originalEvent);
      this._tooltip.style.left=(pos.x+15)+'px';
      this._tooltip.style.top=(pos.y-10)+'px';
      if(this._points.length>0){
        const last=this._points[this._points.length-1];
        const tempLine=L.latLngBounds([last,e.latlng]);
        const d=this._calcDistance(last,e.latlng);
        this._tooltip.innerHTML=this._fmt(d);
      } else {
        this._tooltip.innerHTML='Click to start measuring';
      }
    },

    _keydown:function(e){
      if(e.key==='Escape'){ this._disable(); }
    },

    _calcDistance:function(a,b){
      const R=6371e3; // Earth radius m
      const toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat);
      const dLon=toRad(b.lng-a.lng);
      const lat1=toRad(a.lat);
      const lat2=toRad(b.lat);
      const d=2*R*Math.asin(Math.sqrt(Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2));
      if(this.options.unit==='km') return d/1000;
      if(this.options.unit==='m') return d;
      if(this.options.unit==='mi') return d/1609.34;
      return d;
    },

    _fmt:function(d){
      const u=this.options.unit;
      const p=this.options.precision;
      return d.toFixed(p)+' '+u;
    },

    _updateTooltip:function(latlng){
      if(this._points.length<2)return;
      let total=0;
      for(let i=1;i<this._points.length;i++){
        total+=this._calcDistance(this._points[i-1],this._points[i]);
      }
      this._tooltip.innerHTML=this._fmt(total)+' (Esc to cancel)';
    }

  });

  L.control.measure=function(opts){return new L.Control.Measure(opts);}
});
