/*! simple-measure-tool 1.2 (DG: uses map.distance for CRS scaling) */
(function(factory){
  if(typeof define==='function'&&define.amd){define(['leaflet'],factory);}
  else if(typeof module!=='undefined'){module.exports=factory(require('leaflet'));}
  else{factory(window.L);}
})(function(L){
  if(!L)return;

  L.Control.Measure=L.Control.extend({
    options:{
      position:'topleft',
      color:'#ffe066',
      activeColor:'#ffcc00',
      unit:'km',          // 'm','km','mi','ft'
      precision:2,
      tooltipClass:'dg-measure-tooltip'
    },

    onAdd:function(map){
      this._map=map;
      const c=L.DomUtil.create('div','leaflet-control-measure leaflet-bar');
      this._btn=L.DomUtil.create('a','leaflet-control-measure-toggle leaflet-bar-part',c);
      this._btn.href='#'; this._btn.title='Measure distance'; this._btn.innerHTML='ðŸ“';
      L.DomEvent.on(this._btn,'click',L.DomEvent.stopPropagation)
                .on(this._btn,'click',L.DomEvent.preventDefault)
                .on(this._btn,'click',this._toggle,this);
      return c;
    },
    onRemove:function(){ this._disable(); },

    _toggle:function(){ this._enabled?this._disable():this._enable(); },

    _enable:function(){
      this._enabled=true;
      L.DomUtil.addClass(this._btn,'active');
      this._layer=L.layerGroup().addTo(this._map);
      this._poly=L.polyline([],{color:this.options.color,weight:2}).addTo(this._layer);
      this._points=[];
      this._tooltip=L.DomUtil.create('div',this.options.tooltipClass);
      this._tooltip.innerHTML='Click to start measuring';
      this._map.getContainer().appendChild(this._tooltip);
      this._map.on('mousemove',this._move,this)
               .on('click',this._click,this)
               .on('keydown',this._keydown,this);
    },

    _disable:function(){
      this._enabled=false;
      L.DomUtil.removeClass(this._btn,'active');
      if(this._layer){ this._map.removeLayer(this._layer); }
      if(this._tooltip){ this._tooltip.remove(); }
      this._map.off('mousemove',this._move,this)
               .off('click',this._click,this)
               .off('keydown',this._keydown,this);
      this._layer=null; this._points=[]; this._poly=null; this._tooltip=null;
    },

    _click:function(e){
      const latlng=e.latlng;
      this._points.push(latlng);
      this._poly.addLatLng(latlng);
      this._updateTooltip();
    },

    _move:function(e){
      if(!this._tooltip)return;
      const p=this._map.mouseEventToContainerPoint(e.originalEvent);
      this._tooltip.style.left=(p.x+15)+'px';
      this._tooltip.style.top=(p.y-10)+'px';
      if(this._points.length>0){
        const last=this._points[this._points.length-1];
        const d=this._segDistance(last,e.latlng);
        this._tooltip.innerHTML=this._fmt(d);
      } else {
        this._tooltip.innerHTML='Click to start measuring';
      }
    },

    _keydown:function(e){ if(e.key==='Escape'){ this._disable(); } },

    // --- KEY CHANGE: use map.distance so CRS scaling applies (meters) ---
    _segDistance:function(a,b){
      var meters=this._map.distance(a,b);
      return this._toUnit(meters);
    },

    _total:function(){
      var sum=0;
      for(let i=1;i<this._points.length;i++){
        sum += this._map.distance(this._points[i-1], this._points[i]);
      }
      return this._toUnit(sum);
    },

    _toUnit:function(m){
      switch((this.options.unit||'km').toLowerCase()){
        case 'm':  return m;
        case 'km': return m/1000;
        case 'mi': return m/1609.344;
        case 'ft': return m/0.3048;
        default:   return m/1000;
      }
    },

    _fmt:function(v){
      const u=this.options.unit, p=this.options.precision;
      return v.toFixed(p)+' '+u;
    },

    _updateTooltip:function(){
      if(this._points.length<2){ this._tooltip.innerHTML='Click to add next point'; return; }
      const t=this._total();
      this._tooltip.innerHTML=this._fmt(t)+' (Esc to cancel)';
    }
  });

  L.control.measure=function(opts){return new L.Control.Measure(opts);}
});
