<script>
/* ========= DG Theme Toggle (sidebar-aware) ========= */
(function(){
  function applyTheme(next, reason){
    if(!next) return;
    var root = document.documentElement;
    var body = document.body;

    // <html>
    root.setAttribute('data-theme', next);
    root.classList.remove('theme-dark','theme-light');
    root.classList.add(next === 'dark' ? 'theme-dark' : 'theme-light');

    // <body>
    if (body){
      body.setAttribute('data-theme', next);
      body.classList.remove('theme-dark','theme-light');
      body.classList.add(next === 'dark' ? 'theme-dark' : 'theme-light');
    }

    try { localStorage.setItem('dg-theme', next); } catch(e){}
    var meta = document.querySelector('meta[name="color-scheme"]') || document.createElement('meta');
    meta.setAttribute('name','color-scheme');
    meta.setAttribute('content', next);
    if (!meta.parentNode) document.head.appendChild(meta);

    console.log('[DG THEME] Applied:', next, '('+reason+')');
  }

  function readTheme(){
    var saved = null;
    try { saved = localStorage.getItem('dg-theme'); } catch(e){}
    if (saved) return saved;
    var attr = (document.documentElement.getAttribute('data-theme') || '').toLowerCase();
    if (attr === 'dark' || attr === 'light') return attr;
    return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Re-apply saved theme once <body> exists
    applyTheme(readTheme(), 'dom-ready');

    // Prefer an inline button inside the sidebar if present
    var btn = document.querySelector('[data-theme-toggle]');

    if (!btn) {
      // No sidebar or no placeholder ‚Üí create a floating fallback
      btn = document.getElementById('theme-toggle');
      if (!btn) {
        btn = document.createElement('button');
        btn.id = 'theme-toggle';
        btn.className = 'theme-toggle theme-float';
        document.body.appendChild(btn);
      }

      // Floating styles (only when we created a floating button)
      var css = document.createElement('style');
      css.textContent = `
        .theme-toggle.theme-float {
          position: fixed; bottom: 1rem; right: 1rem; z-index: 99999;
          padding: .5rem .7rem; border-radius: 8px;
          border: 1px solid var(--background-modifier-border, rgba(0,0,0,.15));
          background: var(--background-secondary, rgba(255,255,255,.9));
          color: var(--text-normal, #111);
          cursor: pointer; font-size: .95rem; line-height: 1;
          box-shadow: 0 6px 20px rgba(0,0,0,.15);
        }
        .theme-toggle.theme-float:hover {
          background: var(--background-secondary-alt, rgba(240,240,240,.95));
        }
        :root[data-theme="dark"] .theme-toggle.theme-float {
          background: var(--background-secondary, #1f2430);
          color: var(--text-normal, #eaeaea);
          border-color: var(--background-modifier-border, rgba(255,255,255,.15));
        }
      `;
      document.head.appendChild(css);
    } else {
      // Make sure the inline button has standard classes
      btn.classList.add('theme-toggle','theme-inline');
    }

    function syncLabel(){
      var cur = (document.documentElement.getAttribute('data-theme')||'').toLowerCase();
      btn.textContent = cur === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    syncLabel();

    btn.addEventListener('click', function () {
      var cur = (document.documentElement.getAttribute('data-theme')||'light').toLowerCase();
      var next = (cur === 'dark') ? 'light' : 'dark';
      applyTheme(next, 'toggle');
      syncLabel();
    });

    // Cross-tab sync + BFCache restore
    window.addEventListener('storage', function(e){
      if (e.key === 'dg-theme') { applyTheme(e.newValue, 'storage'); syncLabel(); }
    });
    window.addEventListener('pageshow', function(){
      applyTheme(readTheme(), 'pageshow'); syncLabel();
    });

    console.log('[DG THEME] Toggle ready on this page.');
  });
})();

/* ========= DG Language Toggle (single üá∫üá∏ / üá≠üá∫ button) ========= */
(function(){
  const STORAGE_KEY = 'dg-lang';

  // Client-side fallback: wrap <!--lang:en--> / <!--lang:hu--> into data-lang-block divs
  function ensureLangBlocks() {
    // If Eleventy transform already created them, do nothing
    if (document.querySelector('[data-lang-block]')) return;

    const root =
      document.querySelector('.cm-s-obsidian') ||
      document.querySelector('.markdown-preview-view') ||
      document.querySelector('main') ||
      document.body;

    if (!root) return;

    const walker = document.createTreeWalker(root, NodeFilter.SHOW_COMMENT, null);
    const markers = [];
    let node;

    while ((node = walker.nextNode())) {
      const text = (node.nodeValue || '').trim();
      const match = /^lang:(en|hu)$/i.exec(text);
      if (match) {
        markers.push({ node, lang: match[1].toLowerCase() });
      }
    }

    if (!markers.length) return;

    markers.forEach(({ node, lang }) => {
      const parent = node.parentNode;
      if (!parent) return;

      const wrapper = document.createElement('div');
      wrapper.setAttribute('data-lang-block', lang);
      // insert wrapper right after the comment node
      if (node.nextSibling) {
        parent.insertBefore(wrapper, node.nextSibling);
      } else {
        parent.appendChild(wrapper);
      }

      // Move following siblings into wrapper until we hit another lang comment or end
      let current = wrapper.nextSibling;
      while (current) {
        if (
          current.nodeType === Node.COMMENT_NODE &&
          /^lang:(en|hu)$/i.test((current.nodeValue || '').trim())
        ) {
          break; // stop at next language marker
        }
        const next = current.nextSibling;
        wrapper.appendChild(current);
        current = next;
      }
    });

    console.log('[DG LANG] Client-side lang blocks created.');
  }

  function readLang(){
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved === 'en' || saved === 'hu') return saved;
    } catch(e){}
    return 'en'; // default
  }

  function updateLangButtons(lang) {
    document.querySelectorAll('[data-lang-toggle]').forEach(btn => {
      // text as flags
      btn.textContent = (lang === 'en') ? 'üá∫üá∏' : 'üá≠üá∫';
      btn.setAttribute('aria-label', lang === 'en' ? 'Switch to Hungarian' : 'Switch to English');
    });
  }

  function applyLang(lang, reason) {
    if (lang !== 'en' && lang !== 'hu') lang = 'en';
    const root = document.documentElement;

    // Make sure blocks exist (Eleventy or client-side)
    ensureLangBlocks();

    const hasAnyLangBlocks = document.querySelector('[data-lang-block]');
    const hasTargetLang   = document.querySelector(`[data-lang-block="${lang}"]`);

    if (hasAnyLangBlocks && hasTargetLang) {
      root.setAttribute('data-lang', lang);
    } else {
      // If target language not present on this page, keep everything visible
      root.removeAttribute('data-lang');
    }

    updateLangButtons(lang);

    try { localStorage.setItem(STORAGE_KEY, lang); } catch(e){}
    console.log('[DG LANG] Applied', lang, '('+reason+')');
  }

  document.addEventListener('DOMContentLoaded', function(){
    const current = readLang();
    applyLang(current, 'init');

    // Single toggle button ‚Äì flips en <-> hu
    document.querySelectorAll('[data-lang-toggle]').forEach(btn => {
      btn.addEventListener('click', function(ev){
        ev.preventDefault();
        const current = readLang();
        const next = current === 'en' ? 'hu' : 'en';
        applyLang(next, 'click');
      });
    });

    // Keep in sync across tabs
    window.addEventListener('storage', function(e){
      if (e.key === STORAGE_KEY && (e.newValue === 'en' || e.newValue === 'hu')) {
        applyLang(e.newValue, 'storage');
      }
    });
  });
})();
</script>
