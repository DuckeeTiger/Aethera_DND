<script>
(function () {
  // --- WAIT FOR LEAFLET TO LOAD ---
  function whenLeafletReady(cb) {
    if (window.L) return cb();
    function tryStart(){ if (window.L) { console.log("[DG] Leaflet is ready. Starting init."); cb(); } }
    document.addEventListener("DOMContentLoaded", tryStart);
    window.addEventListener("load", function () {
      tryStart();
      if (!window.L) {
        let tries = 0;
        const t = setInterval(function () {
          tries++; tryStart(); if (window.L || tries > 100) clearInterval(t);
        }, 50);
      }
    });
    setTimeout(tryStart, 0);
  }

  function start() {
    function setSize(el) {
      var h = el.dataset.height || "420px";
      var w = el.dataset.width || "";
      el.style.height = h;
      if (w) el.style.width = w;
    }

    function parsePair(str, a, b) {
      if (!str) return [a, b];
      var parts = ("" + str).split(",").map(function (s) { return parseFloat(s.trim()); });
      return (parts.length === 2 && !parts.some(isNaN)) ? parts : [a, b];
    }

    function initImageMap(el) {
      setSize(el);

      // Parse bounds from data-bounds="y0,x0,y1,x1" (for 2090Ã—3432 image: 0,0,2090,3432)
      var b = (el.dataset.bounds || "0,0,1000,1000")
        .split(",").map(function (s) { return parseFloat(s.trim()); });
      var y0 = b[0], x0 = b[1], y1 = b[2], x1 = b[3];

      // Leaflet (CRS.Simple) uses [y, x] as [lat, lng]
      var southWest = L.latLng(y1, x0);
      var northEast = L.latLng(y0, x1);
      var imgBounds = L.latLngBounds(southWest, northEast);

      // Create map *after* computing bounds so we can clamp panning
      var map = L.map(el, {
        crs: L.CRS.Simple,
        zoomSnap: 0.25,
        zoomDelta: parseFloat(el.dataset.zoomDelta || "0.5"),
        maxBounds: imgBounds,
        maxBoundsViscosity: 1.0
      });

      L.imageOverlay(el.dataset.image, imgBounds, { opacity: 1.0, interactive: false }).addTo(map);

      // Respect min/max zoom if provided
      map.setMinZoom(parseFloat(el.dataset.minZoom || "-2"));
      map.setMaxZoom(parseFloat(el.dataset.maxZoom || "2.5"));

      // Center + default zoom
      var center = parsePair(el.dataset.center, (y0 + y1) / 2, (x0 + x1) / 2);
      map.setView(center, parseFloat(el.dataset.defaultZoom || "0"));

      // Optional markers (inline JSON)
      if (el.dataset.markers) {
        try {
          JSON.parse(el.dataset.markers).forEach(function (m) {
            var marker = L.marker([m.y, m.x]).addTo(map);
            if (m.label) marker.bindPopup(m.label);
          });
        } catch (e) { console.warn("[DG] Invalid data-markers JSON", e); }
      }
    }

    // ðŸš€ Actually initialize all maps on the page
    document.querySelectorAll(".leaflet-map").forEach(initImageMap);

    console.log("[DG] Leaflet maps initialized.");
  }

  whenLeafletReady(start);
})();
</script>
<style>
  .leaflet-map { border-radius: 8px; overflow: hidden; min-height: 300px; }
  .leaflet-container { width: 100%; height: 100%; }
</style>
